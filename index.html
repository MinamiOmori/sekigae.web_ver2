<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>席替えサイト Ver2</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      margin:0; font-family:sans-serif;
      background: #f5f3ff; /* 薄い藤色ベース */
    }
    .main-layout {
      display: flex; height: 100vh;
      background: #f5f3ff;
    }
    .main-left {
      flex:1; display:flex; justify-content:center; align-items:center; min-width:380px;
      background: #ece0fa;
      border-right: 2px solid #d1c4e9;
    }
    .main-right {
      flex:1; background:#f5f3ff;
    }
    .seat-map-area {
      background: #f3eafd;
      padding: 36px 32px 32px 32px;
      border-radius: 16px;
      box-shadow: 0 2px 16px 0 rgba(180,160,240,0.07);
      min-width: 400px;
      position: relative;
    }
    .blackboard {
      position: absolute;
      top: 12px; left: 24px; right: 24px;
      height: 28px;
      background: #5e5c7c;
      border-radius: 12px;
      box-shadow: 0 2px 8px 0 rgba(80,70,140,0.10);
      display: flex; align-items: center; justify-content: center;
      color: #fff;
      font-weight: bold;
      letter-spacing: 0.2em;
      font-size: 1.2em;
      z-index: 2;
    }
    .seat-map { display: flex; flex-direction: row; gap: 12px; margin-top: 56px; }
    .seat-col { display: flex; flex-direction: column; gap: 12px; }
    .seat {
      width: 54px; height: 54px; border-radius: 10px;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      font-weight: bold; border: 2px solid #c2b7e2;
      user-select: none; cursor: pointer;
      font-size: 1.25em; transition: background 0.2s;
      box-shadow: 0 1px 6px 0 rgba(160,140,210,0.05);
      background: #ede7fa;
      color: #6e5c8c;
    }
    .seat.enabled {
      background: #e6e6fa;
      color: #6e5c8c;
      border: 2px solid #c2b7e2;
    }
    .seat.disabled {
      background: #d1c4e9;
      color: #b8a8d1;
      cursor: not-allowed;
      border: 2px dashed #b0a0d0;
    }
    .seat.selected {
      background: #b39ddb;
      color: #fff;
      border: 2px solid #7e57c2;
    }
    .seat .seat-label {
      font-size: 1.05em;
      font-weight: bold;
    }
    .seat .seat-assignment {
      font-size: 0.85em;
      color: #9575cd;
      font-weight: normal;
    }
    .modal-bg { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(180,160,240,0.22); display:flex; justify-content:center; align-items:center; z-index:1000; }
    .modal-main { background:white; padding:32px; border-radius:16px; min-width:370px; box-shadow:0 2px 24px 0 rgba(120,100,180,0.12);}
    @media (max-width: 900px) {
      .main-layout { flex-direction: column; }
      .main-left, .main-right { width:100%; min-width:0; }
      .seat-map-area { min-width: 0; width:100%; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <!-- React & ReactDOM CDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script>
    const { useState, useEffect } = React;
    const ROWS = 6, COLS = 6;

    // 座席表
    function SeatMap({
      seatsEnabled,
      seatAssignments,
      selectMode = false,
      selectedSeats = [],
      onSeatClick,
      maxSelect = 36,
      onDoubleClick
    }) {
      // 座席番号を縦列ごと左→右：col * ROWS + row + 1
      return React.createElement('div', { className: "seat-map-area" },
        React.createElement('div', { className: "blackboard" }, '黒板'),
        React.createElement('div', { className: "seat-map" },
          Array.from({length: COLS}).map((_, col) =>
            React.createElement('div', { className: "seat-col", key: col },
              Array.from({length: ROWS}).map((_, row) => {
                const key = `${row},${col}`;
                const enabled = seatsEnabled[row][col];
                const selected = selectedSeats?.includes(key);
                const seatNum = col * ROWS + row + 1;
                return React.createElement('div', {
                    key: row,
                    className: `seat ${enabled ? "enabled" : "disabled"}${selected ? " selected" : ""}`,
                    onClick: selectMode && enabled ? () => onSeatClick(row, col) : undefined,
                    onDoubleClick: !selectMode && onDoubleClick ? () => onDoubleClick(row, col) : undefined
                  },
                  React.createElement('div', { className: "seat-label" }, seatNum),
                  React.createElement('div', { className: "seat-assignment" }, seatAssignments?.[row]?.[col] || "")
                );
              })
            )
          )
        )
      );
    }

    // モーダル座席選択
    function SeatModal({
      open,
      mode,
      maxSelect,
      seatsEnabled,
      initialSelected = [],
      onClose,
      onSubmit
    }) {
      const [selected, setSelected] = useState(initialSelected);

      useEffect(() => { setSelected(initialSelected); }, [initialSelected, open]);

      function handleSelect(row, col) {
        const key = `${row},${col}`;
        if (selected.includes(key)) {
          setSelected(selected.filter(s => s !== key));
        } else if (selected.length < maxSelect) {
          setSelected([...selected, key]);
        }
      }

      if (!open) return null;
      return React.createElement('div', { className: "modal-bg" },
        React.createElement('div', { className: "modal-main" },
          React.createElement('h3', null, mode === "range" ? "範囲指定席選択" : "固定席選択"),
          React.createElement(SeatMap, {
            selectMode: true,
            seatsEnabled,
            selectedSeats: selected,
            onSeatClick: handleSelect,
            maxSelect
          }),
          React.createElement('div', { style: {marginTop:16} },
            React.createElement('button', { onClick: () => onSubmit(selected), style:{marginRight:8}}, "OK"),
            React.createElement('button', { onClick: onClose }, "キャンセル")
          )
        )
      );
    }

    // 条件設定パネル
    function ConditionPanel({
      ranges, setRanges,
      fixedSeats, setFixedSeats,
      others, setOthers,
      onOpenRangeModal,
      onOpenFixedModal,
      onShuffle
    }) {
      return React.createElement('div', { style: { padding: "24px" } },
        React.createElement('h2', { style: { color: "#7e57c2" } }, "座席条件設定"),

        // 範囲指定グループ
        React.createElement('h3', { style: { color: "#9575cd" } }, "範囲指定"),
        ...ranges.map((group, idx) => React.createElement('div', { key: idx, style:{marginBottom:"8px"}},
          React.createElement('input', {
            type: "text", placeholder: "名前（カンマ区切り）",
            value: group.names.join(","),
            onChange: e => {
              const newRanges = ranges.slice();
              newRanges[idx].names = e.target.value.split(",").map(s => s.trim()).filter(Boolean);
              setRanges(newRanges);
            },
            style: { marginRight: "8px", background: "#f3eafd", color: "#6e5c8c", border: "1.5px solid #c2b7e2", borderRadius: "6px", padding: "3px 9px" }
          }),
          React.createElement('button', { onClick: () => onOpenRangeModal(idx), style:{background:'#b39ddb',color:'#fff',border:'none',borderRadius:'6px',padding:'4px 12px'} }, "範囲指定"),
          React.createElement('span', { style:{marginLeft:8, fontSize:"0.9em", color: "#7e57c2"} }, group.seats?.length ? `指定席数:${group.seats.length}` : ""),
          React.createElement('button', {
            onClick: () => setRanges(ranges.filter((_, i) => i !== idx)),
            style:{marginLeft:"8px", background:'#d1c4e9',color:'#6e5c8c',border:'none',borderRadius:'6px',padding:'4px 12px'}
          }, "削除")
        )),
        React.createElement('button', { onClick: () => setRanges([...ranges, { names: [], seats: [] }]), style:{background:'#b39ddb',color:'#fff',border:'none',borderRadius:'6px',padding:'4px 16px'} }, "範囲指定を追加"),

        // 固定席
        React.createElement('h3', { style: { marginTop: "16px", color: "#9575cd" } }, "固定席"),
        ...fixedSeats.map((fix, idx) => React.createElement('div', { key: idx, style:{marginBottom:"8px"}},
          React.createElement('input', {
            type: "text", placeholder: "名前",
            value: fix.name,
            onChange: e => {
              const newFixed = fixedSeats.slice();
              newFixed[idx].name = e.target.value;
              setFixedSeats(newFixed);
            },
            style: { marginRight: "8px", background: "#f3eafd", color: "#6e5c8c", border: "1.5px solid #c2b7e2", borderRadius: "6px", padding: "3px 9px" }
          }),
          React.createElement('button', { onClick: () => onOpenFixedModal(idx), style:{background:'#b39ddb',color:'#fff',border:'none',borderRadius:'6px',padding:'4px 12px'} }, "座席選択"),
          React.createElement('span', { style:{marginLeft:8, fontSize:"0.9em", color:"#7e57c2"} }, fix.seat ? `指定席:${fix.seat}` : ""),
          React.createElement('button', {
            onClick: () => setFixedSeats(fixedSeats.filter((_, i) => i !== idx)),
            style:{marginLeft:"8px", background:'#d1c4e9',color:'#6e5c8c',border:'none',borderRadius:'6px',padding:'4px 12px'}
          }, "削除")
        )),
        React.createElement('button', { onClick: () => setFixedSeats([...fixedSeats, { name: "", seat: null }]), style:{background:'#b39ddb',color:'#fff',border:'none',borderRadius:'6px',padding:'4px 16px'} }, "固定席を追加"),

        // 範囲指定なし
        React.createElement('h3', { style: { marginTop: "16px", color: "#9575cd" } }, "範囲指定なし"),
        React.createElement('textarea', {
          placeholder: "名前（改行区切り）",
          value: others.join("\n"),
          onChange: e => setOthers(e.target.value.split("\n").map(s => s.trim()).filter(Boolean)),
          rows: 4,
          style: { width: "100%", marginBottom: "16px", background: "#f3eafd", color: "#6e5c8c", border: "1.5px solid #c2b7e2", borderRadius: "6px", padding: "7px 9px" }
        }),

        // 席替えボタン
        React.createElement('button', {
          style: {
            marginTop: "24px",
            background: "#9575cd",
            color: "white",
            padding: "14px 24px",
            fontSize: "1.15rem",
            borderRadius: "12px",
            border: "none",
            width: "100%",
            boxShadow: "0 1px 8px 0 rgba(120,100,180,0.09)"
          },
          onClick: onShuffle
        }, "席替えする")
      );
    }

    // 席替えロジック
    function shuffleSeats({ranges, fixedSeats, others}, seatsEnabled) {
      let seatAssignments = Array(ROWS).fill().map(() => Array(COLS).fill(null));
      let usedSeats = new Set();

      // 固定席
      fixedSeats.forEach(({ name, seat }) => {
        if (!name || !seat) return;
        const [row, col] = seat.split(",").map(Number);
        if (seatsEnabled[row][col] && !seatAssignments[row][col]) {
          seatAssignments[row][col] = name;
          usedSeats.add(seat);
        }
      });

      // 範囲指定
      ranges.forEach(({ names, seats }) => {
        if (!seats) seats = [];
        let availableSeats = seats.filter(s => {
          const [r, c] = s.split(",").map(Number);
          return seatsEnabled[r][c] && !usedSeats.has(s) && !seatAssignments[r][c];
        });
        let shuffledSeats = availableSeats.slice().sort(() => Math.random() - 0.5);
        let shuffledNames = names.slice().sort(() => Math.random() - 0.5);
        shuffledNames.forEach((name, i) => {
          if (shuffledSeats[i]) {
            const [row, col] = shuffledSeats[i].split(",").map(Number);
            seatAssignments[row][col] = name;
            usedSeats.add(shuffledSeats[i]);
          }
        });
      });

      // 残り席
      let remainingSeats = [];
      for (let i = 0; i < ROWS; i++)
        for (let j = 0; j < COLS; j++)
          if (seatsEnabled[i][j] && !seatAssignments[i][j])
            remainingSeats.push([i, j]);
      let shuffledOthers = others.slice().sort(() => Math.random() - 0.5);
      shuffledOthers.forEach((name, i) => {
        if (remainingSeats[i]) {
          const [row, col] = remainingSeats[i];
          seatAssignments[row][col] = name;
        }
      });

      return seatAssignments;
    }

    // 全体App
    function App() {
      const [seatsEnabled, setSeatsEnabled] = useState(
        Array(ROWS).fill().map(() => Array(COLS).fill(true))
      );
      const [seatAssignments, setSeatAssignments] = useState(
        Array(ROWS).fill().map(()=>Array(COLS).fill(null))
      );
      const [ranges, setRanges] = useState([]);
      const [fixedSeats, setFixedSeats] = useState([]);
      const [others, setOthers] = useState([]);
      const [modal, setModal] = useState({ open: false, mode: "", groupIdx: null });

      // 有効/無効トグル
      function handleSeatDoubleClick(row, col) {
        setSeatsEnabled(prev =>
          prev.map((r, i) => r.map((seat, j) => i === row && j === col ? !seat : seat))
        );
      }

      // 範囲指定座席選択
      function handleRangeSeatSelect(selected, idx) {
        const newRanges = ranges.slice();
        newRanges[idx].seats = selected;
        setRanges(newRanges);
        setModal({ open: false });
      }

      // 固定席選択
      function handleFixedSeatSelect(selected, idx) {
        const newFixed = fixedSeats.slice();
        newFixed[idx].seat = selected[0] || null;
        setFixedSeats(newFixed);
        setModal({ open: false });
      }

      // 席替え
      function handleShuffle() {
        const assignments = shuffleSeats({ranges, fixedSeats, others}, seatsEnabled);
        setSeatAssignments(assignments);
      }

      return React.createElement('div', { className:"main-layout" },
        React.createElement('div', { className:"main-left" },
          React.createElement(SeatMap, {
            seatsEnabled,
            seatAssignments,
            onDoubleClick: handleSeatDoubleClick
          })
        ),
        React.createElement('div', { className:"main-right" },
          React.createElement(ConditionPanel, {
            ranges, setRanges,
            fixedSeats, setFixedSeats,
            others, setOthers,
            onOpenRangeModal: idx => setModal({ open: true, mode: "range", groupIdx: idx }),
            onOpenFixedModal: idx => setModal({ open: true, mode: "fixed", groupIdx: idx }),
            onShuffle: handleShuffle
          })
        ),
        React.createElement(SeatModal, {
          open: modal.open,
          mode: modal.mode,
          maxSelect:
            modal.mode === "range"
              ? ranges[modal.groupIdx]?.names.length || 1
              : 1,
          seatsEnabled: seatsEnabled,
          initialSelected:
            modal.mode === "range"
              ? ranges[modal.groupIdx]?.seats || []
              : fixedSeats[modal.groupIdx]?.seat ? [fixedSeats[modal.groupIdx].seat] : [],
          onClose: () => setModal({ open: false }),
          onSubmit: selected =>
            modal.mode === "range"
              ? handleRangeSeatSelect(selected, modal.groupIdx)
              : handleFixedSeatSelect(selected, modal.groupIdx)
        })
      );
    }

    // レンダリング
    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>
